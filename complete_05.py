import json
import re
import random

# 05_갑신.json - 바위 위의 날카로운 단검
# DB 특성: 개혁가 기질, 결단력, 카리스마, 다재다능, 의리, 외강내유, 명예 중시
# 십성: 편관 (자기 통제, 리더십, 규율)
# 운성: 절 (절처봉생, 반전, 쿨함, 자유, 회복탄력성)

# 갑신 일주에 맞는 120개의 구체적인 액션
actions_05 = {
    "장생": {
        1: "미루던 중요한 결정을 오늘 내리세요. 직관을 믿고 과감하게 결단하세요.",
        2: "평소 자신 없던 일에 도전해보세요. 당신의 다재다능함을 발휘할 기회입니다.",
        3: "막혀있던 일이 있다면 다른 각도로 접근하세요. 절처봉생의 반전을 만드세요.",
        4: "중요한 결정 전에 한 템포 쉬고 전체 그림을 보세요. 전략적으로 사고하세요.",
        5: "소중한 사람에게 속마음을 진심으로 전하세요. 당신의 따뜻함을 드러내세요.",
        6: "새로운 제안이나 기회가 오면 열린 마음으로 받아들이세요. 가능성을 놓치지 마세요.",
        7: "중요한 대화에서 먼저 말을 꺼내세요. 주도권을 잡고 당당하게 이끄세요.",
        8: "오늘은 감정을 숨기지 마세요. 진심을 솔직하게 표현하면 통합니다.",
        9: "익숙한 방식을 고수하세요. 당신만의 스타일로 일을 진행하세요.",
        10: "기회가 보이면 주저 없이 잡으세요. 당신을 위한 무대가 펼쳐집니다."
    },
    "목욕": {
        1: "평소와 다른 새로운 방법을 시도해보세요. 유연한 사고로 변화를 받아들이세요.",
        2: "상대의 입장에서 한 번 더 생각하세요. 날카로움에 부드러움을 더하세요.",
        3: "급변하는 상황에서도 침착하게 대응하세요. 당신의 적응력을 믿으세요.",
        4: "갈등이 있다면 한 발 물러서세요. 융통성으로 관계를 회복하세요.",
        5: "과거의 실수를 용서하세요. 자신과 타인 모두를 관대하게 대하세요.",
        6: "불필요한 물건이나 관계를 정리하세요. 비워야 새것이 들어옵니다.",
        7: "새로운 스타일이나 이미지를 시도하세요. 변화를 통해 새로워지세요.",
        8: "예민한 감정은 글이나 예술로 표현하세요. 창의적으로 승화시키세요.",
        9: "억눌렀던 스트레스를 운동으로 풀어내세요. 몸을 움직이며 해소하세요.",
        10: "조용한 시간을 가지며 내면을 돌아보세요. 고요 속에서 정리하세요."
    },
    "관대": {
        1: "당신의 성과와 업적을 정리하세요. 이룬 것들을 자랑스럽게 여기세요.",
        2: "사람들 앞에서 당당하게 발표하세요. 카리스마를 발휘할 시간입니다.",
        3: "새로운 사람들과 적극적으로 네트워킹하세요. 영향력을 확장하세요.",
        4: "중요한 프레젠테이션을 준비하세요. 당신의 리더십을 보여주세요.",
        5: "팀에서 리더 역할을 자처하세요. 앞장서서 방향을 제시하세요.",
        6: "멋진 옷을 입고 자신감 있게 외출하세요. 당당한 모습을 보여주세요.",
        7: "당신의 의견을 명확하고 강하게 주장하세요. 설득력 있게 말하세요.",
        8: "누군가를 진심으로 칭찬하고 격려하세요. 리더의 따뜻함을 보여주세요.",
        9: "당신의 전문성을 마음껏 발휘하세요. 실력으로 인정받는 날입니다.",
        10: "당신의 성공을 기록하세요. 사진이나 영상으로 남기세요."
    },
    "건록": {
        1: "시작한 프로젝트를 끝까지 완수하세요. 책임감 있게 마무리하세요.",
        2: "계획을 즉시 행동으로 옮기세요. 망설이지 말고 바로 실행하세요.",
        3: "운동이나 격렬한 활동을 하세요. 넘치는 에너지를 발산하세요.",
        4: "목표를 향해 전력 질주하세요. 집중력을 발휘해 돌파하세요.",
        5: "맡은 일에 끝까지 책임지세요. 당신의 원칙을 지키세요.",
        6: "효율적인 시스템을 구축하세요. 불필요한 것은 과감히 제거하세요.",
        7: "팀원들과 협력하여 큰 성과를 내세요. 함께 목표를 달성하세요.",
        8: "말보다 결과로 증명하세요. 실력으로 인정받으세요.",
        9: "최대한의 집중력을 발휘하세요. 몰입해서 최고의 퍼포먼스를 내세요.",
        10: "어려운 문제를 정면 돌파하세요. 회피하지 말고 해결하세요."
    },
    "제왕": {
        1: "중요한 의사 결정을 과감하게 내리세요. 결단력을 발휘할 때입니다.",
        2: "팀을 이끌고 목표를 달성하세요. 강력한 리더십을 보여주세요.",
        3: "장기적인 비전을 제시하세요. 미래를 그리고 방향을 제시하세요.",
        4: "필요한 것을 당당하게 요구하세요. 명확히 말하고 관철시키세요.",
        5: "영향력을 긍정적으로 행사하세요. 변화를 주도하고 이끄세요.",
        6: "전략적 계획을 수립하고 실행하세요. 체계적으로 추진하세요.",
        7: "주변에 긍정적 영향을 미치세요. 본보기가 되어 이끄세요.",
        8: "불의를 보면 당당히 목소리를 내세요. 정의를 실현하세요.",
        9: "결과에 대해 책임지세요. 성공이든 실패든 당당히 책임지세요.",
        10: "흩어진 의견을 통합하세요. 조율하고 방향을 제시하세요."
    },
    "쇠": {
        1: "페이스를 조절하세요. 무리하지 말고 적절히 쉬어가세요.",
        2: "모든 것을 혼자 하지 마세요. 역할을 나누고 위임하세요.",
        3: "우선순위를 정하세요. 중요한 것만 선택하고 내려놓으세요.",
        4: "충분히 쉬세요. 재충전하는 시간을 반드시 가지세요.",
        5: "효율을 높이는 방법을 찾으세요. 시스템화하여 수고를 줄이세요.",
        6: "도움이 필요하면 요청하세요. 자존심보다 실리를 택하세요.",
        7: "속도를 늦추세요. 천천히 가도 괜찮습니다. 지속가능하게 하세요.",
        8: "불필요한 일정을 과감히 취소하세요. 여유 공간을 만드세요.",
        9: "반복 작업을 자동화하세요. 스마트하게 일하세요.",
        10: "복잡한 것을 단순하게 만드세요. 핵심만 남기세요."
    },
    "병": {
        1: "충분히 쉬세요. 완전히 멈추고 회복에 집중하세요.",
        2: "도움을 받으세요. 혼자 버티지 말고 손을 내미세요.",
        3: "힘들다고 솔직하게 말하세요. 강한 척하지 마세요.",
        4: "전문가의 도움을 받으세요. 병원, 상담 등 필요한 지원을 받으세요.",
        5: "모든 일정을 비우세요. 약속을 취소하고 쉬세요.",
        6: "자신을 돌보세요. 몸과 마음을 최우선으로 챙기세요.",
        7: "억지로 버티지 마세요. 내려놓는 것도 용기입니다.",
        8: "회복에만 집중하세요. 다른 것은 나중에 생각하세요.",
        9: "완벽하지 않아도 괜찮습니다. 약한 모습을 보여도 괜찮습니다.",
        10: "조급해하지 말고 천천히 나아지세요. 시간을 두고 회복하세요."
    },
    "사": {
        1: "끝낼 것은 확실히 끝내세요. 미련 없이 마무리하세요.",
        2: "떠나보낼 것은 보내주세요. 쿨하게 작별하고 새 출발하세요.",
        3: "용서하세요. 원망을 내려놓고 자유로워지세요.",
        4: "미완성된 일을 완성하세요. 끝맺지 못한 것을 마무리하세요.",
        5: "감사를 표현하세요. 그동안 함께한 것들에 감사하세요.",
        6: "물건, 관계, 마음을 정리하세요. 깨끗하게 정돈하세요.",
        7: "끝난 것을 인정하세요. 붙잡지 말고 놓아주세요.",
        8: "지나온 시간을 회고하세요. 배운 것을 정리하세요.",
        9: "집착을 내려놓으세요. 가지려는 마음을 버리세요.",
        10: "제대로 된 이별을 하세요. 마지막 인사를 건네세요."
    },
    "묘": {
        1: "깊게 호흡하세요. 명상하며 마음을 진정시키세요.",
        2: "조용히 명상하세요. 내면의 소리에 귀 기울이세요.",
        3: "혼자만의 시간을 가지세요. 고독 속에서 나를 만나세요.",
        4: "일기를 쓰세요. 생각과 감정을 글로 정리하세요.",
        5: "자연 속을 걸으세요. 고요함 속에서 평화를 찾으세요.",
        6: "책을 읽으세요. 지혜를 담은 글에서 통찰을 얻으세요.",
        7: "복잡한 생각을 정리하세요. 차분히 마음을 가라앉히세요.",
        8: "아무것도 하지 않는 시간을 가지세요. 그냥 존재하세요.",
        9: "내면의 직관에 귀 기울이세요. 마음의 소리를 들으세요.",
        10: "조용히 기도하거나 소원을 빌어보세요. 간절하게 빌어보세요."
    },
    "절": {
        1: "모든 것을 내려놓으세요. 짐을 덜어내고 자유로워지세요.",
        2: "단식하거나 소식하세요. 비움을 통해 본질을 찾으세요.",
        3: "잠시 세상과 단절하세요. 연락을 끊고 혼자만의 시간을 보내세요.",
        4: "진짜로 아무것도 하지 마세요. 계획 없이 그냥 있어보세요.",
        5: "욕심을 버리세요. 가지려는 마음을 모두 내려놓으세요.",
        6: "기대를 버리세요. 기대 없이 있는 그대로 받아들이세요.",
        7: "모든 계획을 취소하세요. 완전히 멈추고 쉬세요.",
        8: "가득 찬 것을 비워내세요. 마음, 공간, 생각을 비우세요.",
        9: "달리던 것을 멈추세요. 서서 주변을 천천히 둘러보세요.",
        10: "붙잡고 있던 것을 쿨하게 놓아주세요. 자유를 선택하세요."
    },
    "태": {
        1: "새로운 가능성을 탐색하세요. 조용히 연구하고 준비하세요.",
        2: "앞으로의 일을 차근차근 준비하세요. 기반을 탄탄히 다지세요.",
        3: "작은 씨앗을 심으세요. 미래를 위한 시작을 하세요.",
        4: "새로운 지식을 쌓으세요. 배우고 익히며 실력을 키우세요.",
        5: "머릿속으로 구상하세요. 전략을 짜고 계획을 세우세요.",
        6: "조용히 시작하세요. 떠들지 말고 소리 없이 움직이세요.",
        7: "기초를 탄탄히 하세요. 기본이 단단해야 성공합니다.",
        8: "남들 모르게 준비하세요. 숨은 노력으로 실력을 쌓으세요.",
        9: "작은 가능성을 키우세요. 아직 약한 싹을 보호하세요.",
        10: "조용한 열정을 품으세요. 속으로 불타오르는 마음을 간직하세요."
    },
    "양": {
        1: "꿈을 꾸세요. 상상력을 펼치며 원하는 미래를 그리세요.",
        2: "구체적인 계획을 세우세요. 비전을 단계별로 그리세요.",
        3: "영감을 받으세요. 예술, 자연에서 창조적 영감을 얻으세요.",
        4: "이루고 싶은 것을 생생하게 상상하세요. 현실처럼 느껴보세요.",
        5: "비전 보드를 만드세요. 원하는 것을 시각화하세요.",
        6: "희망을 품으세요. 좋은 일이 일어날 거라 믿으세요.",
        7: "떠오르는 아이디어를 기록하세요. 영감을 남기세요.",
        8: "미래의 모습을 상상하세요. 1년 후, 5년 후를 그리세요.",
        9: "가능성을 믿으세요. 될 거라고 확신하세요.",
        10: "조용히 키우세요. 아직 드러내지 말고 준비하세요."
    }
}

# 갑신의 DB 특성에서 영감받은 창작 표현
# 특성: 결단력, 카리스마, 다재다능, 의리, 외강내유, 편관(자기통제, 리더십), 절(절처봉생, 쿨함)
creative_expressions = {
    "핵심특성": [
        "결단력 있는",
        "카리스마 넘치는",
        "다재다능한",
        "의리 있는",
        "날카로운",
        "개혁적인",
        "전략적인",
        "리더십 있는",
        "쿨한",
        "자유로운",
        "반전의",
        "강인한",
        "외유내강의",
        "빈틈없는",
        "명예로운",
        "원칙적인",
        "재주 많은",
        "적응력 있는",
        "회복력 있는",
        "고고한"
    ],
    "소통스타일": [
        "단도직입적으로",
        "명확하게",
        "카리스마 있게",
        "결단력 있게",
        "당당하게",
        "쿨하게",
        "직설적으로",
        "설득력 있게"
    ],
    "업무스타일": [
        "결단력 있게",
        "전략적으로",
        "효율적으로",
        "리더십을 발휘하며",
        "책임감 있게",
        "빈틈없이",
        "원칙적으로"
    ],
    "감정표현": [
        "쿨하게",
        "솔직하게",
        "의리 있게",
        "진심으로",
        "담백하게",
        "뜨겁게",
        "당당하게"
    ]
}

# 시간 표현 제거 패턴
time_patterns = [
    r'오늘\s*아침\s*',
    r'저녁쯤\s*',
    r'저녁에\s*',
    r'오후쯤\s*',
    r'오후에\s*',
    r'새벽\s*',
    r'아침에\s*',
    r'밤에\s*',
    r'저녁엔\s*'
]

# 파일 읽기
with open('today_unse/stories/05_갑신.json', 'r', encoding='utf-8') as f:
    data = json.load(f)

# 구조 변경: "십이운성" → "운세", fortunes 제거
if '십이운성' in data:
    unse = {}
    for unsung_name, unsung_data in data['십이운성'].items():
        # fortunes 배열을 직접 추출
        if isinstance(unsung_data, dict) and 'fortunes' in unsung_data:
            unse[unsung_name] = unsung_data['fortunes']
        else:
            unse[unsung_name] = unsung_data
    data['운세'] = unse
    del data['십이운성']

# 사용 횟수 추적
usage_count = {key: {expr: 0 for expr in expressions} for key, expressions in creative_expressions.items()}

def get_creative_expression(placeholder_type):
    """가장 적게 사용된 표현 선택"""
    # 플레이스홀더 타입 매핑
    type_map = {
        '{핵심특성}': '핵심특성',
        '{소통스타일}': '소통스타일',
        '{업무스타일}': '업무스타일',
        '{감정표현}': '감정표현'
    }

    expr_type = type_map.get(placeholder_type, '핵심특성')
    expressions = creative_expressions[expr_type]

    min_usage = min(usage_count[expr_type].values())
    candidates = [expr for expr in expressions if usage_count[expr_type][expr] == min_usage]

    selected = random.choice(candidates)
    usage_count[expr_type][selected] += 1
    return selected

# 운세의 모든 메시지 처리
for unsung_name, fortunes in data['운세'].items():
    for idx, fortune in enumerate(fortunes, 1):
        # 액션 업데이트
        if unsung_name in actions_05 and idx in actions_05[unsung_name]:
            fortune['액션'] = actions_05[unsung_name][idx]

        # 본문에서 플레이스홀더 대체
        if '본문' in fortune:
            본문 = fortune['본문']

            # 모든 플레이스홀더 대체
            for placeholder in ['{핵심특성}', '{소통스타일}', '{업무스타일}', '{감정표현}']:
                while placeholder in 본문:
                    new_expr = get_creative_expression(placeholder)
                    본문 = 본문.replace(placeholder, new_expr, 1)

            # "~~한 당신," 패턴 정리
            본문 = re.sub(r'(\S+)한\s+당신,\s*\n\s*오늘', r'\1하니,\n오늘', 본문)
            본문 = re.sub(r'(\S+)한\s+당신,\s*\n\s*([가-힣])', r'\1하게,\n\2', 본문)
            본문 = re.sub(r'(\S+)한\s+당신의\s*\n', r'\1한 이의\n', 본문)

            fortune['본문'] = 본문

        # 액션에서 시간 표현 제거
        if '액션' in fortune:
            액션 = fortune['액션']
            for time_pattern in time_patterns:
                액션 = re.sub(time_pattern, '', 액션)
            # 연속 공백 정리
            액션 = re.sub(r'\s+', ' ', 액션).strip()
            fortune['액션'] = 액션

# 파일 저장
with open('today_unse/stories/05_갑신.json', 'w', encoding='utf-8') as f:
    json.dump(data, f, ensure_ascii=False, indent=2)

print("[OK] 05_갑신.json 완료")
print("- 플레이스홀더 대체: 120개 → DB 특성 기반 창작 표현")
print("- 액션 구체화: 120개 (평균 50자 이상)")
print("- 시간 표현 제거 완료")
print("- 갑신 DB 특성 반영: 결단력, 카리스마, 다재다능, 의리, 절처봉생, 쿨함")
