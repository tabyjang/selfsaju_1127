# 격국 시스템 구현 설계

## 1. 격국 결과 데이터 구조

```javascript
{
  // 성공 케이스
  판단가능: true,
  격국: {
    격명칭: "정재격",           // 십성 + "격"
    격용신: "己",              // 격을 이루는 천간
    격분류: "내격",            // "내격" | "외격"
    월지: "未",               // 격국을 판단한 월지

    용신: {                   // 격국에 맞는 용신 정보
      천간: "丙",             // 용신 천간
      십성: "식신",           // 용신의 십성
      설명: "재격에는 식신이 용신"
    },

    성격상태: "성격",          // "성격" | "파격"
    성격조건: [               // 성격을 이루는 조건들
      "격용신이 천간에 투출",
      "일간이 월령을 받아 강함",
      "용신이 있어 균형을 이룸"
    ],

    강도: "강",               // "강" | "중" | "약"
    신뢰도: 95,              // 0-100, 판단의 확실성

    판단근거: {
      방법: "고지_본기투출",   // 어떤 로직으로 판단했는지
      투출천간: ["己"],       // 투출된 지장간들
      일간체크: "일간≠토",    // 특수 체크 사항
      합국여부: null          // 삼합/방합 있었는지
    },

    해석: "미토월에 기토가 투출하여 정재격이 성립합니다. 일간 갑목이 재성을 만나 재물운이 좋으며, 식신 병화가 용신으로 작용하여 안정적인 재물 축적이 가능합니다."
  }
}

// 실패/예외 케이스
{
  판단가능: false,
  메시지: "격국을 판단하기 어렵습니다",
  이유: [
    "월지의 지장간이 천간에 투출되지 않음",
    "삼합/방합도 성립하지 않음"
  ],
  월지: "辰",
  일간: "甲",
  참고사항: "투출이 없는 경우 대운에서 투출되면 격국이 드러날 수 있습니다"
}
```

## 2. 예외 처리 케이스

### 2.1 예외 케이스 분류

#### A. 투출 없음 (가장 흔한 예외)
```javascript
// 케이스: 진월인데 지장간(을, 계, 무) 모두 투출 안됨
if (투출된지장간.length === 0 && !합국성립) {
  return {
    판단가능: false,
    메시지: "격국을 판단하기 어렵습니다",
    이유: ["월지의 지장간이 천간에 투출되지 않음"],
    상세: "진토월의 지장간(을목, 계수, 무토)이 모두 천간에 나타나지 않았습니다"
  };
}
```

#### B. 일간=토 & 본기만 투출 (고지 특수 케이스)
```javascript
// 케이스: 무토 일간 + 미토월 + 기토만 투출
if (일간오행 === '土' && 본기만투출 && 중기여기없음) {
  return {
    판단가능: false,
    메시지: "격국을 판단하기 어렵습니다",
    이유: ["본기(토)는 일간과 같아 비겁이므로 격으로 불가", "중기와 여기가 투출되지 않음"],
    상세: "고지월에서 토 일간일 때는 본기를 격으로 삼을 수 없으나, 다른 지장간도 투출되지 않았습니다"
  };
}
```

#### C. 복잡한 충돌 (여러 격 후보가 동시 성립)
```javascript
// 케이스: 여러 지장간이 동시 투출 + 합국도 성립
if (격후보.length > 1 && 합국성립 && 판단우선순위모호) {
  // 기본 로직에서는 우선순위로 해결하지만
  // 정말 애매한 경우는 예외 처리
  return {
    판단가능: false,
    메시지: "격국을 판단하기 어렵습니다",
    이유: ["여러 격국 후보가 동시에 성립하여 우선순위 판단 불가"],
    후보격국: ["정재격(계수)", "편재격(무토)", "수국(삼합)"]
  };
}
```

#### D. 데이터 무결성 문제
```javascript
// 케이스: 입력 데이터가 이상함
if (월지없음 || 일간없음 || 천간개수 !== 4) {
  return {
    판단가능: false,
    메시지: "사주 데이터가 올바르지 않습니다",
    이유: ["필수 정보 누락 또는 형식 오류"]
  };
}
```

### 2.2 예외 처리 우선순위

1. **데이터 검증** (최우선)
   - 사주 8글자 완전성 체크
   - 월지, 일간 필수 값 체크

2. **특수격 체크**
   - 전왕격, 화기격, 종격 먼저 확인
   - 특수격 성립 시 내격 판단 스킵

3. **내격 판단**
   - 왕지 → 생지 → 고지 순서로 로직 실행
   - 각 단계에서 판단 불가 시 예외 반환

4. **예외 메시지 반환**
   - `판단가능: false` 명확히 표시
   - 이유를 구체적으로 제공

## 3. 통합 판단 플로우

```javascript
function 격국판단(사주) {
  try {
    // ========================================
    // STEP 0: 입력 데이터 검증
    // ========================================
    const 검증결과 = validate사주(사주);
    if (!검증결과.valid) {
      return {
        판단가능: false,
        메시지: "사주 데이터가 올바르지 않습니다",
        이유: 검증결과.errors
      };
    }

    const { 천간4글자, 지지4글자, 일간, 월지 } = 사주;

    // ========================================
    // STEP 1: 외격(특수격) 판단
    // ========================================
    const 특수격결과 = check특수격(사주);
    if (특수격결과.성립) {
      return {
        판단가능: true,
        격국: {
          격명칭: 특수격결과.격명칭,
          격분류: "외격",
          ...특수격결과
        }
      };
    }

    // ========================================
    // STEP 2: 내격 판단 - 월지 분류에 따라
    // ========================================
    const 월지분류 = classify월지(월지);

    let 내격결과;

    switch(월지분류) {
      case '왕지':
        내격결과 = 왕지_격국_판단(월지, 일간, 천간4글자);
        break;

      case '생지':
        내격결과 = 생지_격국_판단(월지, 일간, 천간4글자, 지지4글자);
        break;

      case '고지':
        내격결과 = 고지_격국_판단(월지, 일간, 천간4글자, 지지4글자);
        break;

      default:
        return {
          판단가능: false,
          메시지: "월지 분류 오류",
          이유: ["월지가 12지지에 속하지 않음"]
        };
    }

    // ========================================
    // STEP 3: 내격 판단 결과 확인
    // ========================================
    if (!내격결과 || !내격결과.격용신) {
      return {
        판단가능: false,
        메시지: "격국을 판단하기 어렵습니다",
        이유: 내격결과?.이유 || ["월지의 지장간이 천간에 투출되지 않음"],
        월지: 월지,
        일간: 일간,
        참고사항: "투출이 없는 경우 대운에서 투출되면 격국이 드러날 수 있습니다"
      };
    }

    // ========================================
    // STEP 4: 용신 판단
    // ========================================
    const 용신결과 = determine용신(내격결과, 사주);

    // ========================================
    // STEP 5: 성격/파격 판단
    // ========================================
    const 성격상태 = check성격파격(내격결과, 용신결과, 사주);

    // ========================================
    // STEP 6: 최종 결과 조합
    // ========================================
    return {
      판단가능: true,
      격국: {
        격명칭: 내격결과.격명칭,
        격용신: 내격결과.격용신,
        격분류: "내격",
        월지: 월지,
        용신: 용신결과,
        성격상태: 성격상태.상태,
        성격조건: 성격상태.조건,
        강도: calculate강도(내격결과, 사주),
        신뢰도: calculate신뢰도(내격결과),
        판단근거: 내격결과.판단근거,
        해석: generate해석(내격결과, 용신결과, 성격상태, 사주)
      }
    };

  } catch (error) {
    // 예상치 못한 오류
    return {
      판단가능: false,
      메시지: "격국 판단 중 오류가 발생했습니다",
      이유: [error.message],
      기술정보: error.stack
    };
  }
}
```

## 4. 각 함수별 예외 처리

### 4.1 왕지_격국_판단()
```javascript
function 왕지_격국_판단(월지, 일간, 천간4글자) {
  // 왕지는 예외 케이스가 거의 없음 (본기가 곧 격)
  const 본기 = 왕지_본기[월지];
  const 십성 = calculate십성(일간, 본기);

  // 예외: 본기가 비겁인 경우? → 왕지에서는 이것도 격으로 인정
  // (건록격, 양인격)

  return {
    격용신: 본기,
    격명칭: 십성 + "격",
    판단근거: {
      방법: "왕지_본기",
      투출여부: 천간4글자.includes(본기) ? "투출" : "미투출"
    },
    해석: `${월지}월은 ${본기}의 왕지입니다.`
  };
}
```

### 4.2 생지_격국_판단()
```javascript
function 생지_격국_판단(월지, 일간, 천간4글자, 지지4글자) {
  const 지장간 = 생지_지장간[월지]; // {여기: 무, 중기: X, 본기: Y}

  // Step 1: 본기 투출?
  if (천간4글자.includes(지장간.본기)) {
    return build격국결과(지장간.본기, "생지_본기투출");
  }

  // Step 2: 중기 투출?
  if (천간4글자.includes(지장간.중기)) {
    return build격국결과(지장간.중기, "생지_중기투출");
  }

  // Step 3: 여기(무토) 투출? - 사월만 인정!
  if (천간4글자.includes('戊') && 월지 === '巳') {
    return build격국결과('戊', "생지_여기투출_사월특례");
  }

  // 🚨 예외: 아무것도 투출 안됨
  return {
    격용신: null,
    이유: [`${월지}월의 지장간(${지장간.본기}, ${지장간.중기})이 천간에 투출되지 않음`]
  };
}
```

### 4.3 고지_격국_판단()
```javascript
function 고지_격국_판단(월지, 일간, 천간4글자, 지지4글자) {
  const 지장간 = 고지_지장간[월지]; // {여기: X, 중기: Y, 본기: Z(토)}

  // Step 0: 삼합/방합 확인 (최우선!)
  const 합국 = check삼합방합(지지4글자, 월지);
  if (합국.성립) {
    return build격국결과(합국.합화천간, "고지_합국");
  }

  // Step 1: 본기(토) 투출 + 일간 체크
  if (천간4글자.includes(지장간.본기)) {
    const 일간오행 = get오행(일간);

    if (일간오행 === '土') {
      // 일간=토 → 본기는 비겁이므로 격으로 불가
      // Step 2로 넘어가기 (아래로 계속)
    } else {
      // 일간≠토 → 본기가 격!
      return build격국결과(지장간.본기, "고지_본기투출");
    }
  }

  // Step 2: 중기 투출?
  if (천간4글자.includes(지장간.중기)) {
    return build격국결과(지장간.중기, "고지_중기투출");
  }

  // Step 3: 여기 투출?
  if (천간4글자.includes(지장간.여기)) {
    return build격국결과(지장간.여기, "고지_여기투출");
  }

  // 🚨 예외: 아무것도 안됨
  const 일간오행 = get오행(일간);
  if (일간오행 === '土' && 천간4글자.includes(지장간.본기)) {
    return {
      격용신: null,
      이유: [
        "본기(토)는 일간과 같아 비겁이므로 격으로 불가",
        "중기와 여기가 투출되지 않음"
      ]
    };
  } else {
    return {
      격용신: null,
      이유: [`${월지}월의 지장간이 천간에 투출되지 않음`]
    };
  }
}
```

## 5. UI 표시 방안

### 5.1 성공 케이스 표시
```
┌─────────────────────────────────┐
│ 격국 분석 결과                    │
├─────────────────────────────────┤
│ 격국: 정재격 (成格)               │
│ 격용신: 己土                      │
│ 용신: 丙火 (食神)                 │
│ 신뢰도: ⭐⭐⭐⭐⭐ (95%)         │
├─────────────────────────────────┤
│ 해석:                            │
│ 미토월에 기토가 투출하여          │
│ 정재격이 성립합니다.              │
│ 식신이 용신으로 작용하여          │
│ 안정적인 재물 축적이 가능합니다.  │
└─────────────────────────────────┘
```

### 5.2 예외 케이스 표시
```
┌─────────────────────────────────┐
│ 격국 분석 결과                    │
├─────────────────────────────────┤
│ ⚠️  격국을 판단하기 어렵습니다    │
├─────────────────────────────────┤
│ 이유:                            │
│ • 월지의 지장간이 천간에         │
│   투출되지 않음                  │
│ • 삼합/방합도 성립하지 않음       │
├─────────────────────────────────┤
│ 참고:                            │
│ 투출이 없는 경우 대운에서         │
│ 투출되면 격국이 드러날 수         │
│ 있습니다.                        │
└─────────────────────────────────┘
```

### 5.3 간단한 표시 (모바일 등)
```
격국: 정재격 ✅
용신: 丙火 (食神)

---

격국: 판단 불가 ⚠️
이유: 투출 없음
```

## 6. 예외 케이스 통계 및 처리 전략

### 6.1 예상 발생 빈도
- **투출 없음**: 20-30% (가장 흔함)
- **일간=토 & 본기만 투출**: 5-10%
- **복잡한 충돌**: 5% 미만
- **데이터 오류**: 1% 미만

### 6.2 단계별 대응
```javascript
// 1단계: 명확한 예외 처리
if (투출없음) {
  return "판단 불가" + 상세이유;
}

// 2단계: 대운 정보 제공 (나중에 구현)
if (투출없음 && 대운데이터있음) {
  const 대운투출 = check대운투출();
  return "현재 판단 불가, 대운에서 " + 대운투출.격국 + " 가능성";
}

// 3단계: AI 해석 활용 (최종 단계)
if (판단애매) {
  return "기본 판단 불가" + AI보조해석();
}
```

## 7. 구현 체크리스트

- [ ] 기본 데이터 구조 정의 (십성, 지장간 등)
- [ ] 왕지_격국_판단() 함수 구현
- [ ] 생지_격국_판단() 함수 구현
- [ ] 고지_격국_판단() 함수 구현
- [ ] 예외 처리 로직 구현
  - [ ] 투출 없음 케이스
  - [ ] 일간=토 특수 케이스
  - [ ] 데이터 검증
- [ ] 통합 플로우 함수 구현
- [ ] 용신 판단 로직 (기본)
- [ ] 성격/파격 판단 로직 (기본)
- [ ] UI 표시 컴포넌트
- [ ] 테스트 케이스 작성
  - [ ] 정상 케이스 10개
  - [ ] 예외 케이스 5개

## 8. 테스트 케이스 예시

### 정상 케이스
```javascript
// Test 1: 왕지 - 자월 계수 정관격
{
  일간: "戊",
  월지: "子",
  천간: ["甲", "戊", "癸", "丙"],
  예상결과: {
    판단가능: true,
    격명칭: "정관격",
    격용신: "癸"
  }
}

// Test 2: 생지 - 인월 갑목 식신격
{
  일간: "壬",
  월지: "寅",
  천간: ["甲", "壬", "己", "丙"],
  예상결과: {
    판단가능: true,
    격명칭: "식신격",
    격용신: "甲"
  }
}
```

### 예외 케이스
```javascript
// Test E1: 투출 없음
{
  일간: "甲",
  월지: "辰",
  천간: ["丙", "甲", "庚", "壬"],  // 을·계·무 모두 없음
  예상결과: {
    판단가능: false,
    메시지: "격국을 판단하기 어렵습니다"
  }
}

// Test E2: 일간=토 & 본기만 투출
{
  일간: "戊",
  월지: "未",
  천간: ["戊", "己", "戊", "庚"],  // 기토만 있고 정·을 없음
  예상결과: {
    판단가능: false,
    메시지: "격국을 판단하기 어렵습니다"
  }
}
```

---

## 다음 단계

이 설계 문서를 바탕으로:
1. **기본 데이터 구조** 먼저 코드로 구현 (십성 계산, 지장간 데이터 등)
2. **단위 함수 구현** (왕지 → 생지 → 고지 순서)
3. **통합 플로우** 구현
4. **테스트 케이스**로 검증
5. **UI 컴포넌트** 연결

이제 TODO.md의 각 단계를 실제 코드로 옮기면 됩니다!
