# 격국(格局) 판단 시스템 개발 계획서

## 📌 프로젝트 개요
사주팔자의 격국(格局)을 자동으로 판단하는 시스템을 개발합니다.
격국은 "내가 이 세상에서 어떤 도구를 써서 살아가야 가장 성공하기 쉬운지"를 보여주는 사회적 DNA입니다.

---

## 🎯 개발 목표
1. **내격(內格) vs 외격(外格, 특수격) 판단**
2. **월지(月支) 기반 격국 산출**
3. **합국(三合, 方合) 가중치 적용**
4. **정확한 격국 명칭 출력**

---

## 📂 개발 단계 (Phase)

### **Phase 0: 기초 데이터 구조 정의** ✅ 최우선
> 사주 분석에 필요한 모든 기본 데이터를 정의합니다.

#### 0-1. 천간(天干) 데이터 정의
```javascript
// 10개의 천간: 갑, 을, 병, 정, 무, 기, 경, 신, 임, 계
// 각 천간의 오행(木火土金水)과 음양(陰陽) 속성 포함
```
- [ ] 천간 10개 배열 생성
- [ ] 각 천간의 오행 속성 매핑
- [ ] 각 천간의 음양 속성 매핑

#### 0-2. 지지(地支) 데이터 정의
```javascript
// 12개의 지지: 자, 축, 인, 묘, 진, 사, 오, 미, 신, 유, 술, 해
// 각 지지의 오행과 계절(월) 정보 포함
```
- [ ] 지지 12개 배열 생성
- [ ] 각 지지의 오행 속성 매핑
- [ ] 각 지지의 왕지/생지/고지 분류

#### 0-3. 지장간(地藏干) 데이터 정의
> **핵심!** 지지(地支) 속에 숨어있는 천간(天干)들
```javascript
// 사왕지(자오묘유): 자·묘·유는 2개, 오는 3개
// - 자(子): 임(10) + 계(20)
// - 오(午): 병(10) + 기(9) + 정(11)
// - 묘(卯): 갑(10) + 을(20)
// - 유(酉): 경(10) + 신(20)

// 사생지(인신사해): 7일 + 7일 + 16일 = 30일
// - 인(寅): 무(7) + 병(7) + 갑(16)
// - 신(申): 무(7) + 임(7) + 경(16)
// - 사(巳): 무(7) + 경(7) + 병(16)
// - 해(亥): 무(7) + 갑(7) + 임(16)

// 사고지(진술축미): 9일 + 3일 + 18일 = 30일
// - 진(辰): 을(9) + 계(3) + 무(18)
// - 미(未): 정(9) + 을(3) + 기(18)
// - 술(戌): 신(9) + 정(3) + 무(18)
// - 축(丑): 계(9) + 신(3) + 기(18)
```
- [ ] 사왕지(4개) 지장간 정의
  - [ ] 자·묘·유: 초기 + 본기 (2개)
  - [ ] 오: 초기 + 중기 + 본기 (3개, 기토 섞임)
- [ ] 사생지(4개) 지장간 정의 (7-7-16)
  - [ ] 여기는 모두 무토(戊)
- [ ] 사고지(4개) 지장간 정의 (9-3-18)
  - [ ] 여기는 전달의 남은 기운

#### 0-4. 오행(五行) 상생상극 관계
```javascript
// 상생: 목생화, 화생토, 토생금, 금생수, 수생목
// 상극: 목극토, 토극수, 수극화, 화극금, 금극목
```
- [ ] 오행 5개 정의
- [ ] 상생 관계 함수 구현
- [ ] 상극 관계 함수 구현

#### 0-5. 십성(十星) 관계 정의
```javascript
// 일간 기준으로 다른 글자와의 관계
// 비견, 겁재, 식신, 상관, 편재, 정재, 편관, 정관, 편인, 정인
```
- [ ] 십성 계산 함수 구현 (일간 + 대상 글자 → 십성 반환)
- [ ] 음양 구분 로직 포함 (예: 양+양=편관, 양+음=정관)

#### 0-6. 합(合) 데이터 정의
```javascript
// 천간합: 갑기합토, 을경합금, 병신합수, 정임합목, 무계합화
// 삼합: 인오술(화), 사유축(금), 신자진(수), 해묘미(목)
// 방합: 인묘진(목), 사오미(화), 신유술(금), 해자축(수)
```
- [ ] 천간 5합 정의
- [ ] 삼합(三合) 4개 정의
- [ ] 방합(方合) 4개 정의
- [ ] 반합(半合) 로직 (왕지 포함 2글자)

---

### **Phase 1: 특수격(外格) 판단 시스템** 🔥 핵심
> 일반격(內格) 판단 전에 **반드시 먼저** 특수격인지 확인해야 합니다!

#### 1-1. 전왕격(專旺格) 판단 로직
> 일간과 같은 오행이 지배적인 격국
```
조건:
1. 월령(月令)이 일간과 같은 오행
2. 지지에 방합 또는 삼합으로 일간 오행 국(局) 형성
3. 관살(나를 극하는 오행)이 없거나 무력함
```
- [ ] 월령 득령 여부 확인 함수
- [ ] 지지 합국(방합/삼합) 탐지 함수
- [ ] 관살 존재 여부 및 유력성 판단
- [ ] 5가지 전왕격 명칭 반환
  - 곡직인수격(木), 염상격(火), 가색격(土), 종혁격(金), 윤하격(水)

#### 1-2. 화기격(化氣格) 판단 로직
> 일간이 천간합을 통해 다른 오행으로 변화
```
조건:
1. 일간이 월간/시간과 천간합(5합) 형성
2. 합화된 오행이 월지에서 왕성함 (월령 지원)
3. 합을 방해하는 충·극 없음
```
- [ ] 일간의 천간합 존재 여부 확인
- [ ] 합화 오행과 월령 일치 여부 검증
- [ ] 방해꾼(충, 극) 체크 로직
- [ ] 5가지 화기격 명칭 반환
  - 갑기화토격, 을경화금격, 병신화수격, 정임화목격, 무계화화격

#### 1-3. 종격(從格) 판단 로직
> 일간이 고립무원하여 강한 세력을 따르는 격국
```
조건:
1. 일간이 지지에 통근력이 전혀 없음 (무근無根)
2. 인성(나를 생해주는 오행)도 없거나 무력함
3. 사주 내 특정 오행(식상/재성/관살)이 지배적
```
- [ ] 일간의 지지 통근력 계산 함수
- [ ] 인성 존재 여부 및 유력성 판단
- [ ] 우세 오행(식상/재성/관살) 판별
- [ ] 4가지 종격 명칭 반환
  - 종재격, 종살격, 종아격, 종세격

#### 1-4. 예외처리: 가(假)종격 → 내격 전환
```
지지 지장간에 미약한 뿌리가 있는 경우,
프로그램에서는 "극신약 내격"으로 분류하되,
코멘트에 "종격에 가까운 극신약" 표기
```
- [ ] 미약한 통근력 기준값 설정 (예: 10점 미만)
- [ ] 가종격 판단 및 내격 전환 로직
- [ ] 사용자 안내 메시지 생성

---

### **Phase 2: 내격(內格) 기본 로직** 📖 핵심 알고리즘
> 특수격이 아닌 경우, 월지(月支)를 기준으로 격국 판단

#### 2-1. 자오묘유(子午卯酉) 왕지 격국 판단
> 가장 단순! 본기가 그대로 격이 됨
```javascript
// 자(子) → 계수(癸水)
// 오(午) → 정화(丁火)
// 묘(卯) → 을목(乙木)
// 유(酉) → 신금(辛金)
```
- [ ] 왕지 4개 판별 함수
- [ ] 본기를 바로 격으로 반환
- [ ] 십성 명칭 계산 (일간 vs 본기)

#### 2-2. 인신사해(寅申巳亥) 생지 격국 판단
> 투출(透出) 우선순위: 본기 → 중기 → 여기
```
로직 순서:
1. 본기가 천간에 투출? → 본기가 격
2. 중기가 천간에 투출? → 중기가 격
3. 아무것도 투출 안됨? → 본기가 격 (생지는 기운이 강함)
```
- [ ] 투출(透出) 확인 함수 (천간 4글자 스캔)
- [ ] 본기 → 중기 순서로 우선순위 체크
- [ ] 여기(무토) 특수 처리 🔥
  - 사월(巳)만: 무토 인정 (화토동법)
  - 인월(寅), 신월(申), 해월(亥): 무토 불인정 → 본기로

#### 2-3. 진술축미(辰戌丑未) 고지 격국 판단 🔥 가장 복잡!
> 반드시 투출해야 격이 됨! (잡기재관인격)
```
🔥 중요: 일간이 토(土) 오행이냐 아니냐에 따라 로직이 달라짐!

우선순위 로직:
0. 삼합/방합 확인 (최우선!) → 합국이 형성되면 합화된 오행이 격
1. 본기(토)가 투출?
   - 일간이 토가 아닌 경우: 토가 격 ✅
   - 일간이 토인 경우: 비겁이므로 격 아님! Step 2로 ❌
2. 중기/여기가 투출? → 투출한 것이 격
3. 둘 다 투출? → 세력이 강한 쪽 (수량 > 사령일수 > 위치)
4. 아무것도 투출 안됨?
   - 일간이 토가 아닌 경우: 본기(토)를 격으로 (격 미완성)
   - 일간이 토인 경우: 격국 미정 (파격/가색격 확인)
```
- [ ] Step 0: 삼합/방합 확인 (최우선)
- [ ] Step 1: 본기(토) 투출 & 일간 체크 🔥
  - [ ] 일간이 토인가? 확인
  - [ ] 일간이 토가 아니면 → 토가 격
  - [ ] 일간이 토이면 → Step 2로 (비겁은 격 아님)
- [ ] Step 2: 여기/중기 투출 확인
  - [ ] 하나만 투출 → 그것이 격
  - [ ] 둘 다 투출 → Step 3로
- [ ] Step 3: 중복 투출 시 우선순위 결정
  - [ ] 투출 수량 비교 (최우선)
  - [ ] 사령일수 가중치 (여기 9일 vs 중기 3일)
  - [ ] 투출 위치 비교 (월간 > 시간 > 년간)
- [ ] Step 4: 미투출 시 예외처리
  - [ ] 일간이 토가 아닌 경우: 격국 미완성 메시지
  - [ ] 일간이 토인 경우: 격국 미정 메시지

#### 2-4. 격국 명칭(Label) 결정 로직
> [일간 vs 투출된 글자]의 십성 관계로 명칭 결정
```
중요: 지장간의 음양이 아니라, 천간에 나온 글자의 음양으로 판단!
예: 진토(지장간 계수) → 임수 투출
    → 일간 vs 임수의 관계로 정관/편관 결정
```
- [ ] 일간과 격용신 글자의 십성 계산
- [ ] 10가지 내격 명칭 반환
  - 정격 8가지: 정관격, 편관격(칠살격), 정재격, 편재격, 식신격, 상관격, 정인격, 편인격
  - 특수격 2가지: 건록격, 양인격
  - 월겁격: 음간의 건록격 변형 (건록격과 동급)
- [ ] 건록지/양인지 판단 로직 🔥 중요!
  - 월지가 일간의 건록지인가? → 건록격 (음양 무관)
  - **양인격 (양간만!):**
    - 일간이 양간(甲丙戊庚壬)인가? 체크
    - 월지가 자오묘유(왕지) 중 하나인가?
    - 월지가 일간의 양인지인가? → 양인격 성립 (용신: 칠살)
  - **월겁격 (음간):**
    - 일간이 음간(乙丁己辛癸)이고 월지가 겁재지?
    - → 월겁격 (건록격과 동급, 용신: 식신/재성)

---

### **Phase 3: 합국(會合) 가중치 시스템** ⚡ 세력 변화
> 지지에 삼합/방합이 있으면 월지의 힘이 변함!

#### 3-1. 삼합(三合) 탐지 로직
```
인오술(화국), 사유축(금국), 신자진(수국), 해묘미(목국)
```
- [ ] 지지 4글자에서 삼합 패턴 탐지
- [ ] 완전 삼합(3글자 모두): 100점
- [ ] 반합(월지+왕지): 60점
- [ ] 가합(월지+생지): 20점 (왕지 없으면 약함)

#### 3-2. 방합(方合) 탐지 로직
```
인묘진(목국), 사오미(화국), 신유술(금국), 해자축(수국)
```
- [ ] 지지 4글자에서 방합 패턴 탐지
- [ ] 완전 방합(3글자 모두): 80점
- [ ] 반합(월지+왕지): 40점

#### 3-3. 가중치 점수 계산 알고리즘
```
각 오행(목화토금수)별로 점수 계산:
Score_Element = W_Branch + W_Stem + Synergy_Bonus - Penalty
```
- [ ] 오행별 점수 초기화 (5개 변수)
- [ ] 지지 국(局) 점수 가산
  - [ ] 삼합 점수 추가
  - [ ] 방합 점수 추가
- [ ] 천간 투출 점수 가산 (50점)
- [ ] 시너지 보너스 계산
  - [ ] 투출 + 국 형성 시: 점수 × 2.0
- [ ] 패널티 계산
  - [ ] 본기(토)가 국에 밀릴 때: 점수 × 0.5

#### 3-4. 최종 격국 결정 (우선순위)
```
1. 가장 높은 점수의 오행이 격
2. 동점 시: 투출된 글자 우선
3. 그래도 동점: 월지 본기 우선
```
- [ ] 5개 오행 점수 비교 함수
- [ ] 동점자 처리 로직
- [ ] 최종 격 오행 반환

---

### **Phase 4: 통합 및 흐름 제어** 🎬
> 전체 시스템을 하나로 연결

#### 4-1. 메인 격국 판단 함수
```javascript
function analyzeGeokguk(사주8글자) {
  // Step 0: 입력 검증
  // Step 1: 특수격 판단 (전왕 → 화기 → 종격)
  // Step 2: 내격 판단 (월지 기반)
  // Step 3: 합국 가중치 적용
  // Step 4: 최종 격국 명칭 출력
  return { 격명칭, 격용신, 설명, 점수 };
}
```
- [ ] 입력값 검증 (천간 4개 + 지지 4개)
- [ ] 순차적 격국 판단 플로우
- [ ] 결과 객체 구조 설계
- [ ] 에러 핸들링

#### 4-2. 해석 메시지 생성
```
사용자에게 보여줄 격국 설명과 의미
```
- [ ] 격국별 표준 해석 문구 작성
- [ ] 성격(格局이 맑음) vs 파격(破格) 판단
- [ ] 사회적 적성 가이드 메시지
- [ ] 용신/희신 보조 정보

---

### **Phase 5: 테스트 및 검증** ✅
> 알려진 사주로 정확도 검증

#### 5-1. 단위 테스트 (Unit Test)
- [ ] 지장간 데이터 검증
- [ ] 십성 계산 검증
- [ ] 합 탐지 검증
- [ ] 투출 확인 검증

#### 5-2. 통합 테스트 (Integration Test)
- [ ] 문서에 제시된 케이스 3개 검증
  - Case 1: 진월 + 임수 투간 + 자수 (성격)
  - Case 2: 진월 + 무토 투간 + 자수 (갈등)
  - Case 3: 미월 + 을목 투간 + 묘목
- [ ] 전왕격 케이스 검증
- [ ] 화기격 케이스 검증
- [ ] 종격 케이스 검증

#### 5-3. 엣지 케이스 (예외 상황)
- [ ] 투출이 전혀 없는 경우
- [ ] 모든 글자가 다 투출된 경우
- [ ] 충(沖)이 있는 경우 (향후 확장)
- [ ] 형(刑)이 있는 경우 (향후 확장)

---

## 🚀 개발 우선순위 (권장 순서)

### **1차 목표 (MVP - 최소 기능 제품)**
```
Phase 0 (기초 데이터) → Phase 2-1 (왕지) → Phase 2-4 (명칭)
→ 가장 단순한 왕지(자오묘유) 격국부터 완성
```

### **2차 목표 (핵심 로직)**
```
Phase 2-2 (생지) → Phase 2-3 (고지)
→ 복잡한 인신사해, 진술축미 로직 완성
```

### **3차 목표 (특수격)**
```
Phase 1-1 (전왕격) → Phase 1-2 (화기격) → Phase 1-3 (종격)
→ 외격 판단 시스템 추가
```

### **4차 목표 (고급 기능)**
```
Phase 3 (합국 가중치) → Phase 4 (통합) → Phase 5 (테스트)
→ 삼합/방합 가중치 및 완전체 시스템
```

---

## 📝 개발 시 주의사항

### ⚠️ 꼭 기억해야 할 원칙들

1. **투출(透出)의 중요성**
   - 지장간이 아무리 강해도, 천간에 나와야 격이 됨
   - 예외: 왕지(자오묘유)와 생지(인신사해)는 투출 없어도 본기가 격

2. **음양(陰陽) 구분**
   - 격의 명칭은 [일간 vs 천간에 투출된 글자]의 음양으로 결정
   - 지장간의 음양은 무시!
   - 예: 진토(계수) → 임수 투출 → 일간이 병화면 "편관격"

3. **우선순위 명확화**
   - 특수격 판단을 **반드시 먼저** (전왕 → 화기 → 종격 순)
   - 내격은 그 다음 (월지 기반)
   - 합국 가중치는 마지막 보정

4. **월지(月支)가 왕**
   - 격국의 80%는 월지(월령)가 결정
   - 월지의 지장간을 정확히 알아야 함

5. **투출 위치의 가중치**
   - 같은 조건이면: 월간 > 시간 > 년간
   - 하지만 격을 잡을 자격은 위치 무관 (어디든 투출되면 OK)

6. **예외와 회색지대**
   - 가종격, 가전왕격 등 애매한 케이스는
   - 일단 "내격(극신약)" 또는 "내격(극신강)"으로 분류
   - 코멘트에 "특수격에 가까움" 표기

---

## 📚 참고 자료 체크리스트

### 이미 제공된 정보
- [x] 인신사해(생지) 로직
- [x] 진술축미(고지) 로직
- [x] **지장간 정확한 데이터 (완료!)**
  - [x] 사왕지(자오묘유): 자·묘·유 (10+20), 오 (10+9+11)
  - [x] 사생지(인신사해): 7-7-16 (여기는 모두 무토)
  - [x] 사고지(진술축미): 9-3-18 (여기는 전달 기운)
- [x] 삼합/방합 가중치 수식
- [x] 특수격(전왕/화기/종격) 조건
- [x] 건록격, 양인격 조건 및 용신
- [x] 테스트 케이스 3개

### 추가로 필요할 수 있는 정보
- [ ] 충(沖) 로직 (문서에서 "나중에" 언급)
- [ ] 형(刑) 로직 (문서에 없음)
- [ ] 파격(破格) 세부 조건
- [ ] 용신(用神) 선정 로직 (격국 다음 단계)

---

## 🛠️ 기술 스택 권장사항

```javascript
// 데이터 구조는 객체와 배열로 명확하게
const 지장간 = {
  인: { 여기: { 글자: '무', 일수: 7 }, 중기: { 글자: '병', 일수: 7 }, 본기: { 글자: '갑', 일수: 16 } },
  // ...
};

// 함수는 단일 책임 원칙으로
function check투출(천간배열, 찾을글자) { ... }
function calculate십성(일간, 대상) { ... }
function detect삼합(지지배열) { ... }
```

---

## 💬 질문 사항 (개발 전 확인 필요)

1. **지장간 사령일수가 학파마다 다르다고 했는데, 어떤 기준을 사용할까요?**
   - 현재 문서: 여기9일, 중기3일, 본기18일
   - 다른 기준도 적용 가능하도록 설정값으로 뺄까요?

2. **가종격, 가전왁격 등 애매한 케이스 처리 방침은?**
   - 현재 방침: 내격으로 분류 + 코멘트 표기
   - 이대로 진행할까요?

3. **충(沖), 형(刑)은 현재 단계에서 제외할까요?**
   - 문서에 "나중에"라고 표기됨
   - Phase 6 이후로 미룰까요?

4. **프론트엔드 UI에 표시할 정보 범위는?**
   - 격국 명칭만?
   - 격국 + 설명 + 점수?
   - 격국 + 설명 + 용신 정보?

---

## ✅ 체크리스트 사용법

각 항목 앞의 `[ ]`를 완료하면 `[x]`로 변경하세요.
```markdown
- [x] 완료된 작업
- [ ] 미완료 작업
```

---

## 🎯 다음 단계

**이 TODO.md를 확인한 후:**
1. Phase 0 (기초 데이터 구조)부터 시작
2. 각 Phase마다 파일 생성 (예: `geokguk-phase0.js`)
3. 테스트 케이스 파일도 함께 작성 (예: `geokguk-phase0.test.js`)

**주석을 많이 달아서 나중에 봐도 이해할 수 있도록!**

---

작성일: 2025-12-04
버전: 1.0
작성자: Claude Code
